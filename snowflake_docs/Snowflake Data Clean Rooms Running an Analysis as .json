{
    "url": "https://docs.snowflake.com/en/user-guide/cleanrooms/demo-flows/provider-run-analysis",
    "title": "Snowflake Data Clean Rooms: Running an Analysis as a Provider | Snowflake Documentation",
    "paragraphs": [
        "Feature \u2014 Generally Available",
        "Not available in government regions.",
        "This topic provides an example of a provider creating and sharing a clean room, then running an analysis in the clean room after the consumer links their data. The process of a provider executing an analysis in the clean room is commonly referred to as \u201cprovider-run analysis\u201d.",
        "Important",
        "If a consumer allows a provider to run an analysis on a template, the consumer, not the provider, is charged for the credits consumed by\nthe provider\u2019s analysis. After the consumer has allowed the provider to run analyses, the consumer must uninstall the clean room to stop\nincurring costs.",
        "If a consumer wants to obtain an estimate of the number of credits consumed by the provider within a specific time period, they can\nexecute the following query, where -5 returns an estimate of the previous 5 days of compute consumption by the provider:",
        "The flow of this example switches between the actions taken by the provider and the actions taken by the consumer. This flows consists of the following actions:",
        "Provider:",
        "a. Creating a clean room for an overlay study.",
        "b. Linking datasets to the clean room.",
        "c. Adding policies governing which columns can be joined on and used in the analysis.",
        "d. Enabling a predefined overlap analysis template.",
        "e. Sharing the clean room with the consumer.",
        "f. Configuring the clean room to allow themselves to run an analysis.",
        "g. Configuring the clean room to prevent the consumer from running analyses. In this example, the consumer acts as a data provider only.",
        "h. Running an overlap study with the consumer who has installed the clean room.",
        "Consumer:",
        "a. Installing the clean room shared by the provider.",
        "b. Linking datasets to the clean room.",
        "c. Setting security policies on datasets.",
        "d. Approving the provider\u2019s ability to run analyses in the clean room.",
        "You need two separate Snowflake accounts to complete this example. Use the first account to execute the provider\u2019s commands, then switch to the second account to execute the consumer\u2019s commands.",
        "Use a Snowflake worksheet in the provider account to execute the commands in this section.",
        "Before using the Developer APIs, you need to assume the SAMOOHA_APP_ROLE role and specify the warehouse used to execute the APIs. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Execute the following commands to set up your environment:",
        "Create a name for the clean room. Enter a new clean room name to avoid colliding with existing clean room names. Note that clean room names can only be alphanumeric. Clean room names cannot contain special characters other than spaces and underscores.",
        "First, execute the following command to set a clean room name for the example clean room:",
        "If a clean room with the specified name already exists, this process fails.",
        "This procedure may take a little longer to run, typically about half a minute.",
        "The second argument to provider.cleanroom_init is the distribution of the clean room. This can either be INTERNAL or EXTERNAL. For testing purposes, if you are sharing the clean room to an account in the same organization, you can use INTERNAL to bypass the automated security scan that must take place before an application package is released to collaborators. However, if you are sharing this clean room to an account in a different organization, you must use an EXTERNAL clean room distribution.",
        "In order to view the status of the security scan, execute the following command:",
        "Once you have created your clean room, you must set its release directive before it can be shared with any collaborator. However, if your distribution was set to EXTERNAL, you must first wait for the security scan to complete before setting the release directive. You can continue running the remainder of the steps and return here before the provider.create_or_update_cleanroom_listing step while the scan runs.",
        "In order to set the release directive, execute the following command:",
        "You can link tables into the clean room by specifying fully qualified table names (<Database>.<Schema>.<Table>) as an array. For example, to link a table into both clean rooms, execute the following command:",
        "Note",
        "If this step doesn\u2019t work even though your table exists, the database that contains the table might not be registered. To register the database, execute the following commands as a user with the ACCOUNTADMIN role.",
        "You can verify that the datasets were linked to the clean room by executing the following command:",
        "To determine which columns to use as the join policy, you can look at your dataset to determine the PII columns. For example, to see the top 10 rows of a table, execute the following query:",
        "Next, specify which columns the consumer is allowed to join on when running templates within the clean room. This procedure should be called on identity columns like email. If you set the join policy a second time, the previously set join policy is completely replaced by the new one.",
        "If you want to view the join policy that has been added to the clean room, execute the following command:",
        "Templates determine the type of analyses that can be executed in a clean room. In this example, you are using a predefined template that lets collaborators run an analysis on the overlap between the provider\u2019s datasets and the consumer\u2019s datasets.",
        "Note that this template natively implements the additional security guarantees provided by differential privacy.",
        "Before setting a column policy on a table, execute a query to display the columns of the table. For example, to view the top 10 rows, execute the following command:",
        "For every table and template combination, set the columns that the analyst can use in an analysis, for example, the columns they can group on or aggregate. This gives flexibility so that the same table can allow different column selections depending on the underlying template. Wait until after you have added a template to set the column policy on a table.",
        "Note that the column policy is replace only, so if the function is called again, then the previously set column policy is completely replaced by the new one.",
        "Column policies should not be used on identity columns like email, HEM, or RampID because you don\u2019t want the analyst to be able to group by these columns. In the production environment, the Snowflake infers PII columns and blocks this operation, but this inference is not available in a sandbox environment. It should only be used on columns that you want the analyst to be able to aggregate and group by, for example, Status, Age Band, Region Code, or Days Active.",
        "To set the column policy for a template/table combination, execute the following command:",
        "If you want to view the column policy that has been added to the clean room, execute the following command:",
        "Finally, add a data consumer to the clean room by adding their Snowflake account locator and account names as shown below. The Snowflake account name must be of the form <ORGANIZATION>.<ACCOUNT_NAME>.",
        "Note",
        "Before executing the following command, make sure you have set the release directive using provider.set_default_release_directive. You can see the latest available version and patches by executing the following command:",
        "To share the clean room with a consumer, execute the following commands:",
        "Multiple consumer account locators can be passed into the provider.add_consumers function as a comma separated string, or as separate calls to provider.add_consumers.",
        "If you want to view the consumers who have been added to the clean room, execute the following command:",
        "Note",
        "You must use the APIs in this section after you share the clean room with a consumer, but before the consumer installs it. If you change the configuration of the clean room after a consumer has installed it, the consumer must reinstall the clean room.",
        "For this example, you are going to configure the clean room so the provider can run analyses, but the consumer cannot. This means the consumer will only be able to add datasets and set security policies.",
        "To configure the clean room so the provider can run an analysis, execute the following command:",
        "Note",
        "Though not used for this example, the provider can reverse the configuration and prevent themselves from running analyses by executing the provider.disable_provider_run_analysis command.",
        "By default, a consumer can run analyses in a clean room. To configure the clean room to prevent the consumer from running analyses, execute the following command:",
        "Note",
        "Though not used for this example, the provider can reverse the configuration and allow the consumer to run analyses by executing the provider.enable_consumer_run_analysis command.",
        "You are now switching to act as the consumer of the clean room. Use a Snowflake worksheet in the consumer account to execute the commands in this section.",
        "Before using the Developer APIs, you need to assume the SAMOOHA_APP_ROLE role and specify the warehouse used to execute the APIs. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Execute the following commands to set up your environment:",
        "Before installing the clean room that the provider has shared with you, assign a name for the clean room.",
        "The following command installs the clean room in the consumer account:",
        "Now you can link some of your datasets into the clean room. The provider will use this data when they run an analysis in the clean room.",
        "Note",
        "If this step doesn\u2019t work even though your table exists, the database that contains the table might not be registered. To register the database, execute the following commands as a user with the ACCOUNTADMIN role.",
        "If you want to view the datasets that you have added to the clean room, call the following procedure.",
        "In this section, you\u2019ll specify which columns the provider is allowed to join on when executing analyses in the clean room. You should execute the following command on identity columns like email. The join policy is \u201creplace only\u201d, so if the function is called again, then the previously set join policy is completely replaced by the new one.",
        "For every table and template combination, set the columns that the provider can use in an analysis, for example, the columns they can group on or aggregate. This gives flexibility so that the same table can allow different column selections depending on the underlying template. Wait until after you have added a template to set the column policy on a table.",
        "Note that the column policy is replace only, so if the function is called again, then the previously set column policy is completely replaced by the new one.",
        "Column policies should not be used on identity columns like email, HEM, or RampID because you don\u2019t want the provider to be able to group by these columns. In the production environment, the Snowflake infers PII columns and blocks this operation, but this inference is not available in a sandbox environment. It should only be used on columns that you want the provider to be able to aggregate and group by, for example, Status, Age Band, Region Code, or Days Active.",
        "To set the column policy for a template/table combination, execute the following command:",
        "A consumer needs to explicitly approve a provider\u2019s ability to run analyses on a template-by-template basis. Without this approval, the provider cannot run an analysis, even if they configured the clean room so they can.",
        "First, you can check if the provider configured the clean room so they can execute analyses.",
        "Next, you can execute the following command to allow the provider to run analyses. You must execute the command for every template you want the provider to be able to use. You should give your approval after setting the join and column policies to prevent the provider from running an analysis on unprotected data.",
        "You are now switching back to the provider account to run the analysis in the clean room. Use a Snowflake worksheet in the provider account to execute the commands in this section.",
        "Running an analysis as a provider processes data in the consumer\u2019s account. To retrieve the results of the analysis, the provider needs access to information coming back from the consumer to the provider. Execute the following command to gain access to information originating from the consumer:",
        "The provider executes the provider.submit_analysis_request command when they want to run an analysis.",
        "The provider.submit_analysis_request command returns a request identifier. You must save this identifier so you can check the status of the analysis request\nand retrieve the analysis results. For example, you could execute the following to save the identifier into a local variable:",
        "After you submit the request to perform an analysis, you can look at the status of the request by executing the following command. Note that there might be a delay when you execute the command for the first time.",
        "Note",
        "If this API fails, make sure you configured the clean room to allow provider run analyses before you installed their clean room as the consumer. If the clean room was configured after the consumer installed a clean room, the consumer must re-install the clean room.",
        "When the status returned by the provider.check_analysis_status command is COMPLETED, you can retrieve the results of the analysis by executing the following command:",
        "Was this page helpful?",
        "On this page",
        "Related content"
    ]
}