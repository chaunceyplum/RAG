{
    "url": "https://docs.snowflake.com/en/user-guide/cleanrooms/demo-flows/basic-flow-overlap",
    "title": "Snowflake Data Clean Rooms: Overlap Analysis | Snowflake Documentation",
    "paragraphs": [
        "Feature \u2014 Generally Available",
        "Not available in government regions.",
        "This topic describes the provider and consumer flows needed to programmatically set up a clean room, share it with a consumer, and run provider-side data analyses in it. A provider-side data analysis is one where the consumer does not have to bring in their datasets but simply wants to get aggregated insights about the provider\u2019s datasets.",
        "It will cover the following:",
        "Provider:",
        "a. Creating a fresh clean room.",
        "b. Securely linking datasets to it.",
        "c. Adding policies governing which columns can be joined on, and used in the analysis.",
        "d. Enabling a predefined overlap analysis template.",
        "e. Sharing it with a consumer.",
        "Consumer:",
        "a. Installing a clean room shared by the provider.",
        "b. Adding your datasets to the clean room.",
        "c. Examining the template provided within the clean room.",
        "d. Running an analysis within the clean room using the template.",
        "You need two separate Snowflake accounts to complete this flow. Use the first account to execute the provider\u2019s commands, then switch to the second account to execute the consumer\u2019s commands.",
        "Note",
        "The following commands should be run in a Snowflake worksheet in the provider account.",
        "Execute the following commands to set up the Snowflake environment before using developer APIs to work with a Snowflake Data Clean Room. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Create a name for the clean room. Enter a new clean room name to avoid colliding with existing clean room names. Note that clean room names can only be alphanumeric. Clean room names cannot contain special characters other than spaces and underscores.",
        "You can create a new clean room with the clean room name set above. If the clean room name set above already exists as an existing clean room, this process fails.",
        "This procedure typically takes about half a minute to run.",
        "The second argument to provider.cleanroom_init is the distribution of the clean room. This can either be INTERNAL or EXTERNAL. For testing purposes, if you are sharing the clean room to an account in the same organization, you can use INTERNAL to bypass the automated security scan which must take place before an application package is released to collaborators. However, if you are sharing this clean room to an account in a different organization, you must use an EXTERNAL clean room distribution.",
        "In order to view the status of the security scan, use:",
        "Once you have created your clean room, you must set its release directive before it can be shared with any collaborator. However, if your distribution was set to EXTERNAL, you must first wait for the security scan to complete before setting the release directive. You can continue running the remainder of the steps while the scan completes and return here before the provider.create_or_update_cleanroom_listing step.",
        "In order to set the release directive, call:",
        "In order to share a clean room with a Snowflake customer whose account is in a different region than your account, you must enable Cross-Cloud Auto-Fulfillment. For information about the additional costs associated with collaborating with consumers in other regions, see Cross-Cloud Auto-Fulfillment costs.",
        "When using developer APIs, enabling cross-region sharing is a two-step process:",
        "A Snowflake administrator with the ACCOUNTADMIN role enables Cross-Cloud Auto-Fulfillment for your Snowflake account. For instructions, see Collaborate with accounts in different regions.",
        "You execute the provider.enable_laf_for_cleanroom command to enable Cross-Cloud Auto-Fulfillment for the clean room. For example:",
        "After you have enabled Cross-Cloud Auto-Fulfillment for the clean room, you can add consumers to your listing as usual using the provider.create_or_update_cleanroom_listing command. The listing is automatically replicated to remote clouds and regions as needed.",
        "Link Snowflake tables into the clean room. Browse through the list of tables in your Snowflake account and enter the fully qualified table names (Database.Schema.Table) as an array. The procedure automatically makes the table accessible to the clean room by creating a secure view of the table from within the clean room, thereby avoiding any need to make a copy of your table.",
        "Note",
        "If this step doesn\u2019t work even though your table exists, it is likely the SAMOOHA_APP_ROLE role has not yet been given access to it. If so, switch to the ACCOUNTADMIN role, call the below procedure on the database, and then switch back for the rest of the flow:",
        "If you want to view the datasets that have been added to the clean room, call the following procedure.",
        "In order to figure out which columns to use as the join policy, you can look at your dataset to determine the PII columns. To see the top 10 rows, execute the following query:",
        "Specify which columns the consumer is allowed to join on when running templates within the clean room. This procedure should be called on identity columns like email. The join policy is \u201creplace only\u201d, so if the function is called again, then the previously set join policy is completely replaced by the new one.",
        "If you want to view the join policy that has been added to the clean room, call the following procedure.",
        "Add a list of predefined templates using their name identifiers. In this flow, you are going to add a predefined template that allows a consumer to carry out an analysis on the overlap between their datasets and provider datasets in a secure and provider-approved manner on provider-approved columns.",
        "One crucial detail about this template is that it natively implements the additional security guarantees provided by Differential Privacy. See Differential Privacy to learn more.",
        "If you want to view the templates currently active in the clean room, call the following procedure. You can see the modifications you need to use to enable Differential Privacy guarantees on your analysis. A similar pattern can be incorporated into any custom template you choose to write.",
        "Note",
        "Note that all system-defined preset templates are encrypted and aren\u2019t viewable by default. Any custom templates that you add will be visible, however.",
        "Any template added to the clean room can also be cleared away if needed. See the Provider API Reference Guide for more details.",
        "Display the data linked to see the columns present inside the table. To view the top 10 rows, call the following procedure.",
        "Set the columns the consumer can group and aggregate (e.g. SUM/AVG) and generally use in an analysis for every table and template combination. This gives flexibility so the same table can allow different column selections depending on the underlying template. This should only be called after adding the template.",
        "Note that the column policy is replace only, so if the function is called again, then the previously set column policy is completely replaced by the new one.",
        "Column policy should not be used on identity columns like email, HEM, RampID, etc. since you don\u2019t want the consumer to be able to group by these columns. In the production environment, the system will intelligently infer PII columns and block this operation, but this feature is not available in the sandbox environment. It should only be used on columns that you want the consumer to be able to aggregate and group by, like Status, Age Band, Channel, Days Active, etc.",
        "If you want to view the column policy that has been added to the clean room, call the following procedure.",
        "Finally, add a data consumer to the clean room by adding their Snowflake account locator and account names as shown below. The Snowflake account name must be of the form <ORGANIZATION>.<ACCOUNT_NAME>.",
        "Note",
        "In order to call the following procedures, make sure you have first set the release directive using provider.set_default_release_directive. You can see the latest available version and patches using:",
        "Multiple consumer account locators can be passed into the provider.add_consumers function as a comma separated string, or as separate calls to provider.add_consumers.",
        "If you want to view the consumers who have been added to this clean room, call the following procedure.",
        "If you want to view the clean rooms that have been created recently, use the following procedure.",
        "If you want to get more insights about the clean room that you have created, use the following procedure.",
        "Any clean room created can also be deleted. The following command drops the clean room entirely, so any consumers who previously had access to the clean room will no longer be able to use it. If a clean room with the same name is desired in the future, it must be re-initialized using the above flow.",
        "Note",
        "The provider flow is finished at this point. Switch to the consumer account to continue with the consumer flow.",
        "Note",
        "The following commands should be run in a Snowflake worksheet in the consumer account",
        "Execute the following commands to set up the Snowflake environment before using developer APIs to work with a Snowflake Data Clean Room. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Once a clean room share has been installed, the list of clean rooms available can be viewed using the below command.",
        "Assign a name for the clean room that the provider has shared with you.",
        "The following command installs the clean room in the consumer account with the associated provider and selected clean room. Enter the provider\u2019s Snowflake account locator (not name).",
        "This procedure may take a little longer to run, typically about half a minute.",
        "Once the clean room has been installed, the provider has to finish setting up the clean room on their side before it is enabled for use. The below function allows you to check the status of the clean room. Once it has been enabled, you should be able to run the Run Analysis command below. It typically takes about 1 minute for the clean room to be enabled.",
        "Now you can link some of your datasets into the clean room to carry out secure computation with the provider\u2019s data.",
        "Note",
        "If this step doesn\u2019t work even though your table exists, it is likely the SAMOOHA_APP_ROLE role has not yet been given access to it. If so, switch to the ACCOUNTADMIN role, call the below procedure on the database, and then switch back for the rest of the flow:",
        "To run the analysis, you will need to pass in the consumer table. If you want to view the datasets that you have added to the clean room, call the following procedure.",
        "Now that the clean room is installed, you can run the analysis template given to the clean room by the provider using a \u201crun_analysis\u201d command. You can see how each field is determined in the sections below.",
        "Note",
        "Before running the analysis, you can alter the warehouse size, or use a new, bigger, warehouse size if your tables are large.",
        "For each of the columns referred to in either the dataset filtering \u201cwhere_clause\u201d, or the dimensions or measure_columns, you can use p. to refer to fields in provider tables, and c. to refer to fields in consumer tables. Use p2, p3, etc. for more than one provider table and c2, c3, etc. for more than one consumer table.",
        "To run the analysis, you need to pass in some parameters to the run_analysis function. This section shows you how to determine what parameters to pass in.",
        "Template names",
        "First, you can see the supported analysis templates by calling the following procedure.",
        "Before running an analysis with a template, you need to know what arguments to specify and what types are expected. For custom templates, you can execute the following.",
        "Note",
        "Note that all system-defined preset templates are encrypted and aren\u2019t viewable by default. Any custom templates that you add will be visible, however.",
        "This can often also contain a large number of different SQL Jinja parameters. The following functionality parses the SQL Jinja template and extracts the arguments that need to be specified in run_analysis into a list.",
        "Note",
        "Note that all system-defined preset templates are encrypted, and so this function will not get the arguments for these templates. You will be able to retrieve the parameters for your custom templates, however.",
        "Dataset names",
        "If you want to view the dataset names that have been added to the clean room by the provider, call the following procedure. Note that you cannot view the data present in the datasets that have been added to the clean room by the provider due to the security properties of the clean room.",
        "You can also see the tables you\u2019ve linked to the clean room by using the following call:",
        "Dimension and measure columns",
        "While running the analysis, you might want to filter, group by and aggregate on certain columns. If you want to view the column policy that has been added to the clean room by the provider, call the following procedure.",
        "Epsilon and privacy budgets",
        "If you are getting an error as a result of the last execution procedure, it might be because there is no budget left for such high epsilon that you have chosen. You can check the remaining privacy budget using the below procedure.",
        "The epsilon parameter that you specify is an input to the Differential Privacy mechanism operating inside the clean room. See the Differential Privacy section for more on how Differential Privacy works. The higher the value of epsilon you specify, the more of the finite privacy budget (reset daily) you consume, but the higher the accuracy of the result since less noise is added to the aggregated data.",
        "Common errors",
        "If you are getting Not approved: unauthorized columns used error as a result of run analysis, you might want to view the join policy and column policy set by the provider again.",
        "It is also possible that you have exhausted your privacy budget, which prevents you from executing more queries. Your remaining privacy budget can be viewed using the below command. It resets daily, or the clean room provider can reset it if they wish.",
        "You can check if Differential Privacy has been enabled for your clean room using the following API:",
        "Was this page helpful?",
        "On this page",
        "Related content"
    ]
}