{
    "url": "https://docs.snowflake.com/en/user-guide/tables-iceberg-configure-external-volume-s3",
    "title": "Configure an external volume for Amazon S3 | Snowflake Documentation",
    "paragraphs": [
        "Grant Snowflake restricted access to your Amazon S3 bucket using an external volume for\nApache Iceberg\u2122 tables in Snowflake.",
        "As a best practice, create a designated IAM policy that grants Snowflake access to your S3 location.\nYou can then attach the policy to a role, and use the security credentials generated by AWS for that role to access the files.",
        "Before you configure an external volume, you need the following:",
        "An S3 storage bucket in the same region that hosts your Snowflake account.",
        "To use the external volume for externally managed Iceberg tables, all of your table data and metadata files must\nbe located in the bucket.",
        "Snowflake can\u2019t support external volumes with bucket names that contain dots (for example, my.s3.bucket).\nSnowflake uses virtual-hosted-style paths and HTTPS to access data in S3.\nHowever, S3 does not support SSL for virtual-hosted-style buckets with dots in the name.",
        "To support data recovery, enable versioning for your external cloud storage location.",
        "Permissions in AWS to create and manage IAM policies and roles. If you aren\u2019t an AWS administrator, ask your AWS administrator to perform these tasks.",
        "To configure access permissions for Snowflake in the AWS Management Console, do the following:",
        "Log in to the AWS Management Console.",
        "From the home dashboard, search for and select IAM.",
        "From the left-hand navigation pane, select Account settings.",
        "Under Security Token Service (STS) in the Endpoints list, find the Snowflake\nregion where your account is located. If the STS status is inactive,\nmove the toggle to Active.",
        "From the left-hand navigation pane, select Policies.",
        "Select Create Policy.",
        "For Policy editor, select JSON.",
        "Add a policy to provide Snowflake with the required permissions to read and write data to your S3 location.",
        "The following example policy grants access to all locations in the specified bucket.",
        "Note",
        "Replace my_bucket with your actual bucket name. You can also specify a path in the bucket; for example, my_bucket/path.",
        "Setting the \"s3:prefix\": condition to [\"*\"] grants access to all prefixes in the\nspecified bucket; setting it to [\"path/*\"] grants access to a specified path in the bucket.",
        "For buckets in government regions, the bucket ARNs use the arn:aws-us-gov:s3::: prefix.",
        "Select Next.",
        "Enter a Policy name (for example, snowflake_access) and an optional Description.",
        "Select Create policy.",
        "Create an AWS IAM role to grant privileges on the S3 bucket containing your data files.",
        "From the left-hand navigation pane in the Identity and Access Management (IAM) Dashboard, select Roles.",
        "Select Create role.",
        "For the trusted entity type, select AWS account.",
        "Under An AWS account, select This account. In a later step,\nyou modify the trust relationship and grant access to Snowflake.",
        "Select the Require external ID option. Enter an\nexternal ID of your choice.\nFor example, iceberg_table_external_id.",
        "An external ID is used to grant access to your AWS resources (such as S3 buckets) to a third party like Snowflake.",
        "Select Next.",
        "Select the policy that you created for the external volume, then select Next.",
        "Enter a Role name and description for the role, then select Create role.",
        "You have now created an IAM policy for an S3 location, created an IAM role, and attached the policy to the role.",
        "Select View role to view the role summary page. Locate and record the ARN (Amazon Resource Name) value for the role.",
        "If you want to upload an object encrypted with an AWS KMS key to Amazon S3,\nthe IAM role that you created for your external volume needs kms:GenerateDataKey permissions on the key.\nTo download an object encrypted with an AWS KMS key, the IAM role needs kms:Decrypt permissions on the key.",
        "If you want to use a KMS key for your server-side encryption, follow these steps to create a key and reference it.",
        "In the AWS Management Console, go to the Key Management Service (KMS). From the left navigation, select Customer managed keys, and then select Create key.\nYou must create a key in the same region as your bucket.",
        "Create a Symmetric key type. For the key usage, select Encrypt and decrypt. Select Next.",
        "For Alias, enter a name for the key and select Next.",
        "If needed, select an administrator for the key and select Next.",
        "For Define key usage permissions, select your IAM role, then select Next.",
        "Review the key configuration details, then select Finish to create the key.",
        "Find the key in the list of customer managed keys, select it, and record its ARN.\nThe following is an example of an ARN for a key: arn:aws:kms:us-west-2:111111122222:key/1a1a11aa-aa1a-aaa1a-a1a1-000000000000.",
        "When you create your external volume, set the KMS_KEY_ID value to the ARN of your key.",
        "Create an external volume using the CREATE EXTERNAL VOLUME command.\nThe following example creates an external volume named iceberg_external_volume\nthat defines a single Amazon S3 storage location with encryption.",
        "The example specifies the\nexternal ID (iceberg_table_external_id) associated with the IAM role that you created for the external volume.\nSpecifying an external ID lets you use the same IAM role (and external ID) across multiple external volumes.",
        "Note",
        "Specify ARNs exactly as provided by AWS. ARNs are case-sensitive.",
        "Retrieve the ARN for the AWS IAM user that was created automatically\nfor your Snowflake account using the DESCRIBE EXTERNAL VOLUME command.\nSpecify the name of your external volume.",
        "The following example describes an external volume named iceberg_external_volume.",
        "Record the value for the STORAGE_AWS_IAM_USER_ARN property, which is the AWS IAM user created for your Snowflake account;\nfor example, arn:aws:iam::123456789001:user/abc1-b-self1234.",
        "Snowflake provisions a single IAM user for your entire Snowflake account. All S3 external volumes in your account use that IAM user.",
        "Note",
        "If you didn\u2019t specify an external ID (STORAGE_AWS_EXTERNAL_ID) when you created an external volume,\nSnowflake generates an ID for you to use. Record the value so that you can update your IAM role trust policy with the generated external ID.",
        "In this step, you configure permissions that allow the IAM user for your Snowflake account to access objects in your S3 bucket.",
        "Log in to the AWS Management Console.",
        "From the home dashboard, search for and select IAM.",
        "From the left-hand navigation pane, select Roles.",
        "Select the IAM role that you created for your external volume.",
        "Select the Trust relationships tab.",
        "Select Edit trust policy.",
        "Modify the policy document with the DESC EXTERNAL VOLUME output values that you recorded.",
        "Policy document for IAM role",
        "Where:",
        "snowflake_user_arn is the STORAGE_AWS_IAM_USER_ARN value you recorded.",
        "iceberg_table_external_id is your external ID. If you already specified an external ID when you created the role, and used the same\nID to create your external volume, leave the value as-is. Otherwise, update sts:ExternalId with the value that you recorded.",
        "Note",
        "You must update this policy document if you create a new external volume (or recreate an existing external volume using the CREATE OR\nREPLACE EXTERNAL VOLUME syntax) and don\u2019t provide your own external ID.\nFor security reasons, a new or recreated external volume has a different external ID and cannot\nresolve the trust relationship unless you update this trust policy.",
        "Select Update policy to save your changes.",
        "To check that Snowflake can successfully authenticate to your storage provider, call the SYSTEM$VERIFY_EXTERNAL_VOLUME\nfunction.",
        "After you configure an external volume, you can create an Iceberg table.",
        "To create a read-only Iceberg table that uses an external catalog, see\nConfigure a catalog integration.",
        "To create an Iceberg table with full Snowflake platform support,\nsee Create a Snowflake-managed table.",
        "Was this page helpful?",
        "On this page",
        "Related content"
    ]
}