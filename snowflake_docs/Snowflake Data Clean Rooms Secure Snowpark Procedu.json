{
    "url": "https://docs.snowflake.com/en/user-guide/cleanrooms/demo-flows/snowpark",
    "title": "Snowflake Data Clean Rooms: Secure Snowpark Procedures | Snowflake Documentation",
    "paragraphs": [
        "Feature \u2014 Generally Available",
        "Not available in government regions.",
        "This topic describes the provider and consumer flows needed to programmatically set up a clean room, share it with a consumer, and run analyses on it in a way that uses secure Snowpark procedures loaded into the clean room from the provider\u2019s account. In this flow, a provider loads a secure Snowpark procedure into the clean room using an API that keeps the underlying Python code completely confidential from the consumer.",
        "The Snowpark procedure in this flow is carrying out a linear regression of Reach on Impression count to estimate the slope. It takes as input a table with Impression IDs, User IDs and Timestamps on the provider\u2019s account, and optionally a table of users from a consumer. The Snowpark procedure dynamically creates SQL to join the impressions data onto the consumer\u2019s users data if it is supplied, and create an intermediary table in the clean room that contains the count of impressions and reach by day.",
        "Next, this data from the intermediary table is processed inside the Snowpark procedure, and a regression is carried out to estimate the intercept, slope, and a number of other parameters. This data is then written to a results table inside the clean room, and the ID of this table is given to the consumer as an output. Finally, the consumer can use a get_results template with this ID to get the data back from the clean room. Before the Snowpark procedure finishes, it cleans up all the intermediary tables created in the clean room.",
        "Note: all intermediary tables are created inside the clean room, and so aren\u2019t accessible to anyone but the Snowpark procedure itself.",
        "The key aspects of this flow other than the ones mentioned above are:",
        "Provider:",
        "a. Securely add a Snowpark procedure into the clean room.",
        "b. Add a custom template that runs the Snowpark procedure, and another that retrieves the results.",
        "c. Share the clean room with a consumer.",
        "Consumer:",
        "a. Run the template that carries out the regression.",
        "b. Retrieve the results of the analysis.",
        "You need two separate Snowflake accounts to complete this flow. Use the first account to execute the provider\u2019s commands, then switch to the second account to execute the consumer\u2019s commands.",
        "Note",
        "The following commands should be run in a Snowflake worksheet in the provider account.",
        "Execute the following commands to set up the Snowflake environment before using developer APIs to work with a Snowflake Data Clean Room. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Create a name for the clean room. Enter a new clean room name to avoid colliding with existing clean room names. Note that clean room names can only be alphanumeric. clean room names cannot contain special characters other than spaces and underscores.",
        "You can create a new clean room with the clean room name set above. If the clean room name set above already exists as an existing clean room, this process will fail.",
        "This procedure takes approximately 45 seconds to run.",
        "The second argument to provider.cleanroom_init is the distribution of the clean room. This can either be INTERNAL or EXTERNAL. For testing purposes, if you are sharing the clean room to an account in the same organization, you can use INTERNAL to bypass the automated security scan which must take place before an application package is released to collaborators. However, if you are sharing this clean room to an account in a different organization, you must use an EXTERNAL clean room distribution.",
        "In order to view the status of the security scan, use:",
        "Once you have created your clean room, you must set its release directive before it can be shared with any collaborator. However, if your distribution was set to EXTERNAL, you must first wait for the security scan to complete before setting the release directive. You can continue running the remainder of the steps and return here before the provider.create_or_update_cleanroom_listing step while the scan runs.",
        "In order to set the release directive, call:",
        "In order to share a clean room with a Snowflake customer whose account is in a different region than your account, you must enable Cross-Cloud Auto-Fulfillment. For information about the additional costs associated with collaborating with consumers in other regions, see Cross-Cloud Auto-Fulfillment costs.",
        "When using developer APIs, enabling cross-region sharing is a two-step process:",
        "A Snowflake administrator with the ACCOUNTADMIN role enables Cross-Cloud Auto-Fulfillment for your Snowflake account. For instructions, see Collaborate with accounts in different regions.",
        "You execute the provider.enable_laf_for_cleanroom command to enable Cross-Cloud Auto-Fulfillment for the clean room. For example:",
        "After you have enabled Cross-Cloud Auto-Fulfillment for the clean room, you can add consumers to your listing as usual using the provider.create_or_update_cleanroom_listing command. The listing is automatically replicated to remote clouds and regions as needed.",
        "Link Snowflake tables into the clean room. These datasets will be made available to you on your account through the latest patch. Browse through the list of tables in your Snowflake account and enter the fully qualified table names (Database.Schema.Table) as an array. The procedure automatically makes the table accessible to the clean room by creating a secure view of the table from within the clean room, thereby avoiding any need to make a copy of your table.",
        "If you\u2019d like to link a view to the clean room instead that has downstream dependencies, use provider.link_datasets_advanced instead:",
        "Note",
        "If this step doesn\u2019t work even though your table exists, it is likely the SAMOOHA_APP_ROLE role has not yet been given access to it. If so, switch to the ACCOUNTADMIN role, call the below procedure on the database, and then switch back for the rest of the flow:",
        "You can see the datasets linked to the clean room using the following procedure:",
        "In order to figure out which columns to use as the join policy, you can peek into your dataset to determine the PII columns. To see the top 10 rows, use this query:",
        "This section shows you how to load the Snowpark procedure into the clean room. The procedure carries out the following steps:",
        "Preprocess impressions data: dynamic SQL is created that joins the provider impressions data onto the consumer users data, if the consumer\u2019s table is supplied, and calculates the distinct count of impressions and reach by date, and stores them in an intermediary table inside the clean room. If the consumer table is not supplied, then it uses the entirety of the provider\u2019s impressions table.",
        "Load intermediary table: the intermediary table is loaded into the Snowpark procedure as a pandas dataframe.",
        "Carry out regression: the regression is calculated using the statsmodels library and the results returned as a pandas dataframe.",
        "Write results to Snowflake table: the results are written to a results table inside the clean room, and the ID suffix of the table is returned to the consumer.",
        "a. Since the Snowpark procedure is running inside the clean room, it has a limited ability to write directly to the consumer tenant. Instead, to keep the results more secure, it is written to a table inside the clean room and give consumers the ability to read from the table.",
        "Drop intermediary tables: intermediary tables created during the calculation inside the clean room that are no longer needed are dropped before the Snowpark procedure finishes.",
        "The following API allows you to define your Python functions directly as inline functions into the clean room. Alternatively you can load Python from staged files you\u2019ve uploaded into the clean room stage. See the API reference guide for an example.",
        "Note",
        "Loading Python into the clean room creates a new patch for the clean room. If your clean room distribution is set to EXTERNAL, you need to wait for the security scan to complete, then update the default release directive using:",
        "To add a custom analysis template to the clean room you need a placeholder for table names on both the provider and consumer sides, along with join columns from the provider side. In SQL Jinja templates, these placeholders must always be:",
        "source_table: an array of table names from the provider",
        "my_table: an array of table names from the consumer",
        "Table names can be made dynamic through using these variables, but they can also be hardcoded into the template if desired using the name of the view linked to the cleanroom. Column names can either be hardcoded into the template, if desired, or set dynamically through parameters. If they are set through parameters, remember that you need to call the parameters dimensions or measure_column, which need to be arrays, in order for them to be checked against the column policy. You add these as SQL Jinja parameters in the template that will be passed in later by the consumer when querying. The join policies ensure that the consumer cannot join on columns other than the authorized ones.",
        "Alternatively, any argument in a custom SQL Jinja template can be checked for compliance with the join and column policies using the following filters:",
        "join_policy: checks if a string value or filter clause is compliant with the join policy",
        "column_policy: checks if a string value or filter clause is compliant with the column policy",
        "join_and_column_policy: checks if columns used for a join in a filter clause are compliant with the join policy, and that columns used as a filter are compliant with the column policy",
        "For example, in the clause {{ provider_id | sqlsafe | join_policy }}, an input of p.HEM will be parsed to check if p.HEM is in the join policy. Note: Only use the sqlsafe filter with caution as it allows collaborators to put pure SQL into the template.",
        "Note",
        "All provider/consumer tables must be referenced using these arguments since the name of the secure view actually linked to the clean room will be different to the table name. Critically, provider table aliases MUST be p (or p1), p2, p3, p4, etc. and consumer table aliases must be c (or c1), c2, c3, etc. This is required in order to enforce security policies in the clean room.",
        "Note that this function overrides any existing template with the same name. If you want to update any existing template, you can simply call this function again with the updated template.",
        "Finally, a custom template is added that will allow the consumer to retrieve the results of their analysis given the results suffix ID returned to them from the calculate_regression template.",
        "If you want to view the templates that are currently active in the clean room, call the following procedure.",
        "Finally, add a data consumer to the clean room by adding their Snowflake account locator and account names as shown below. The Snowflake account name must be of the form <ORGANIZATION>.<ACCOUNT_NAME>.",
        "Note",
        "In order to call the following procedures, make sure you have first set the release directive using provider.set_default_release_directive. You can see the latest available version and patches using:",
        "Note",
        "Note this call takes about 60 seconds to complete, since it sets up a number of tasks for listening and logging requests from the consumer.",
        "Multiple consumer account locators can be passed into the provider.add_consumers function as a comma separated string, or as separate calls to provider.add_consumers.",
        "If you want to view the consumers who have been added to this clean room, call the following procedure.",
        "View the clean rooms that have been recently created via the following procedure:",
        "View more insights on the clean room recently created via the following procedure.",
        "Any clean room created can also be deleted. The following command drops the clean room entirely, so any consumers who previously had access to the clean room will no longer be able to use it. If a clean room with the same name is desired in the future, it must be re-initialized using the above flow.",
        "Note",
        "The provider flow is now finished. Switch to the consumer account to continue with consumer flow.",
        "Note",
        "The following commands should be run in a Snowflake worksheet in the consumer account",
        "Execute the following commands to set up the Snowflake environment before using developer APIs to work with a Snowflake Data Clean Room. If you don\u2019t have the SAMOOHA_APP_ROLE role, contact your account administrator.",
        "Once a clean room share has been installed, the list of clean rooms available can be viewed using the below command.",
        "Assign a name for the clean room that the provider has shared with you.",
        "The following command installs the clean room on the consumer account with the associated provider and selected clean room.",
        "This procedure takes approximately 45 seconds to run.",
        "Once the clean room has been installed, the provider has to finish setting up the clean room on their side before it is enabled for use. The below function allows you to check the status of the clean room. Once it has been enabled, you should be able to run the Run Analysis command below. It typically takes about 1 minute for the clean room to be enabled.",
        "Make sure the install_cleanroom function has finished before running this function.",
        "Link datasets into the clean room to carry out secure computation with the provider\u2019s data. These datasets will be made available to you on your account through the latest patch.",
        "Note",
        "If this step doesn\u2019t work even though your table exists, it is likely the SAMOOHA_APP_ROLE role has not yet been given access to it. If so, switch to the ACCOUNTADMIN role, call the below procedure on the database, and then switch back for the rest of the flow:",
        "To run the analysis, you will need to pass in the consumer table. If you want to view the datasets that you have added to the clean room, call the following procedure.",
        "Now that the clean room is installed, you can run the analysis template given to the clean room by the provider using a \u201crun_analysis\u201d command. You can see how each field is determined in the sections below.",
        "The number of datasets passable is constrained by the template the provider has implemented. Some templates require a specific number of tables. The template creator can implement the requirements they wish to support.",
        "Note",
        "Before running the analysis, you can alter the warehouse size, or use a new, bigger, warehouse size if your tables are large.",
        "The output of this analysis will be an ID that can be used to retrieve the results of the regression using the following template:",
        "To run the analysis, you need to pass in some parameters to the run_analysis function. This section will show you how to determine what parameters to pass in.",
        "Template names",
        "First, you can see the supported analysis templates by calling the following procedure.",
        "To run the analysis, you need to pass in some parameters to the run_analysis function. This section shows you how to determine what parameters to pass in.",
        "This can often also contain a large number of different SQL Jinja parameters. The following functionality parses the SQL Jinja template and extracts the arguments that need to be specified in run_analysis into a list.",
        "Dataset names",
        "If you want to view the dataset names that have been added to the clean room by the provider, call the following procedure. Note that you cannot view the data present in the datasets that have been added to the clean room by the provider due to the security properties of the clean room.",
        "You can also see the tables you\u2019ve linked to the clean room by using the following call:",
        "Keep all significant data pre-processing happening through dynamic SQL where possible, storing data in intermediary tables using the cleanroom schema. It is much faster and more efficient. For example:",
        "Create UDFs, UDTFs and Procedures by executing SQL via session.sql in the cleanroom schema rather than using the Snowpark decorators. For example:",
        "When you need to load data that is too big to fit in memory, use .to_pandas_batches() and iterate over it. For example:",
        "Was this page helpful?",
        "On this page",
        "Related content"
    ]
}